# 自动化索引测试工作流

## 🚀 快速开始

### 方法 1：使用默认配置（推荐）

```bash
python auto_workflow_arxiv.py
```

这会自动：
1. 测试 6 种不同的索引配置（IVF1024/2048/4096/8192 + PQ32/64）
2. 对每个索引进行 autotune，找到最优参数
3. 使用最优参数进行详细测试
4. 生成完整的对比报告

### 方法 2：指定数据集

```bash
# 测试所有三种查询类型
python auto_workflow_arxiv.py arxiv_all

# 只测试 equal 类型
python auto_workflow_arxiv.py arxiv
```

## 📁 输出文件

所有结果保存在 `results/auto_workflow/` 目录：

```
results/auto_workflow/
├── workflow_20251130_153045.log      # 详细运行日志
├── summary_20251130_153045.txt       # 汇总报告（重点看这个）
└── results_20251130_153045.json     # JSON格式的完整结果
```

## 📊 汇总报告示例

```
================================================================================
Query Type: EQUAL
================================================================================

Index                Best Params               R@1      R@10     R@100    Time(ms)  
--------------------------------------------------------------------------------
IVF1024_PQ32         nprobe=4,ht=2             0.9850   0.9950   1.0000   0.234     
IVF4096_PQ64         nprobe=1,ht=2             1.0000   1.0000   1.0000   0.054     
IVF8192_PQ64         nprobe=2,ht=2             1.0000   1.0000   1.0000   0.089     
Flat                                           1.0000   1.0000   1.0000   2.345     

================================================================================
Recommendations:
================================================================================

EQUAL:
  Best configuration: IVF4096_PQ64
  Optimal parameters: nprobe=1,ht=2
  R@1: 1.0000, Time: 0.054ms
```

## 🔧 自定义配置

编辑 `index_configs.json` 来添加或修改索引配置：

```json
{
  "index_configs": [
    {
      "name": "自定义名称",
      "key": "IVF2048,PQ48",
      "description": "你的描述"
    }
  ]
}
```

## 📈 工作流程说明

```
对每个索引配置：
  ├─ 1. 训练索引（自动缓存）
  ├─ 2. 填充向量（自动缓存）
  ├─ 3. 运行 autotune
  │    └─ 找到最优搜索参数
  ├─ 4. 使用最优参数进行详细测试
  │    └─ 获取 R@1, R@10, R@100, 时间等指标
  └─ 5. 记录所有结果
```

## 🎯 使用建议

### 快速测试（约5分钟）
只测试一个索引配置：
```python
# 修改 auto_workflow_arxiv.py 中的 index_configs
self.index_configs = [
    {'name': 'IVF4096_PQ64', 'key': 'IVF4096,PQ64'},
]
```

### 标准测试（约15分钟）
测试 3-4 个常用配置

### 完整测试（约30-60分钟）
使用默认的 6 个配置 + Flat 基准

## 💡 结果解读

- **R@1**: Top-1 召回率（最重要的指标）
- **R@10**: Top-10 召回率
- **R@100**: Top-100 召回率
- **Time(ms)**: 单次查询平均耗时

**选择标准**：
- 追求速度：选择时间最短的配置
- 追求准确：选择 R@1 最高的配置
- 平衡：选择 R@1 高且时间合理的配置

## 🔍 手动运行单个配置

如果你想单独测试某个配置：

```bash
# 1. Autotune
python bench_arxiv.py arxiv_all IVF4096,PQ64 autotune

# 2. 使用找到的参数测试
python bench_arxiv.py arxiv_all IVF4096,PQ64 "nprobe=1,ht=2"
```

## ❓ 常见问题

**Q: 为什么要测试多个索引配置？**
A: 不同的数据集特性适合不同的索引配置。通过测试找到最适合你数据的配置。

**Q: IVF 和 PQ 参数怎么选？**
A: 
- IVF 聚类数：越大越准确但越慢，通常是数据量的平方根
- PQ 字节数：越大越准确但内存占用越多

**Q: nprobe 和 ht 是什么？**
A: 
- nprobe: 搜索时探测几个聚类中心（越大越准确但越慢）
- ht: 汉明阈值，用于 PQ 预筛选

**Q: 结果可以重现吗？**
A: 索引训练后会缓存在 `/tmp/bench_polysemous/`，重复运行会使用缓存的索引。

